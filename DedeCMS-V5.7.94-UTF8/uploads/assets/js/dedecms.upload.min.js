"use strict";let albumIdData=[],albumUploadData=[],fileSize=2;function dedecmsAlbumDelete(that){let div=$(that).parent().parent().parent().parent(),id=div.attr("id");$(`#${id} .uk-card-body input:hidden`).each((function(){div.after($(this))})),div.remove()}function dedecmsAlbumEdit(that){let files=$(that).prop("files");if(files){files=Array.from(files);let file=files[0];if(void 0===file)return;if(/(image\/)/i.test(file.type)){let reader=new FileReader;reader.onload=function(){let img=$(that).next(),input=$(that).parent().next().children().children("input"),src=this.result,remark=file.name.substring(0,file.name.lastIndexOf("."));img.attr("src",src),input.val(remark),input.attr("value",remark)},reader.readAsDataURL(file)}}}function dedecmsAlbumDataUpdate(){let albumIds=$("#dedecms-album-ids");albumIdData=[],$(".dedecms-album-id").each((function(){let id=$(this).attr("id");id=id.replace("albumId",""),-1===albumIdData.indexOf(id)&&albumIdData.push(id)})),albumIds.val(JSON.stringify(albumIdData))}function dedecmsAlbumPreview(that){let files=$(that).prop("files"),albumPreview=$("#dedecms-album-preview"),albumPreviewProgress=$("#dedecms-album-preview-progress"),albumUploadFiles=$("#dedecms-album-upload-files");files&&(files=Array.from(files),$.each(files,(function(i,file){if(void 0!==file)if(file.size>1024*fileSize*1024)UIkit.notification({message:`[${file.name}] 图片大小超过${fileSize}MB`,status:"danger",pos:"bottom-center",timeout:1e4});else if(/(image\/)/i.test(file.type)){let id=""+(new Date).valueOf()+random(1e3,9999),html=`\n                <div id="${id}">\n                    <input type="hidden" class="dedecms-album-preview-name">\n                    <input type="hidden" class="dedecms-album-preview-remark">\n                    <div class="uk-card uk-card-default">\n                        <div class="uk-card-header uk-padding-small">\n                            <div class="uk-flex uk-flex-between uk-invisible">\n                                <span class="uk-sortable-handle" uk-icon="icon: arrows-move"></span>\n                                <button type="button" uk-close onclick="dedecmsAlbumPreviewDelete(this)"></button>\n                            </div>\n                        </div>\n                        <div class="uk-card-body uk-padding-remove uk-text-center" uk-form-custom>\n                            <input type="file" accept="image/*" onchange="dedecmsAlbumPreviewEdit(this)" disabled>\n                            <img class="uk-height-small">\n                            <div>图片上传中...</div>\n                        </div>\n                        <div class="uk-card-footer uk-padding-small">\n                            <progress class="uk-progress uk-margin-small-bottom" max="100"></progress>\n                            <div class="uk-flex uk-flex-middle">\n                                <label class="uk-form-label uk-width-auto uk-margin-small-right">注释</label>\n                                <input class="uk-input uk-form-small uk-width-expand" type="text" value="图片上传中..." onkeyup="dedecmsAlbumPreviewEdit(this)" disabled>\n                            </div>\n                        </div>\n                    </div>\n                </div>`;albumPreview.append(html);let reader=new FileReader;reader.onload=function(){$(`#${id} img`).attr("src",this.result)},reader.readAsDataURL(file);let formData=new FormData;formData.append("file",file),$.ajax({method:"POST",url:"upload.php",data:formData,dataType:"json",processData:!1,contentType:!1}).always((function(res){if("success"===res.status){let name=res.name,remark=res.remark;$(`#${id} .dedecms-album-preview-name`).val(name),$(`#${id} .dedecms-album-preview-remark`).val(remark),$(`#${id} .uk-card-body div`).html("图片上传成功"),$(`#${id} progress`).val(100),$(`#${id} .uk-card-footer input`).val(remark),$(`#${id} .uk-card-footer input`).attr("value",remark),albumUploadData.push({name:name,remark:remark}),albumUploadFiles.val(JSON.stringify(albumUploadData))}else $(`#${id} .dedecms-album-preview-name`).val(""),$(`#${id} .dedecms-album-preview-remark`).val(""),$(`#${id} .uk-card-body div`).html("图片上传失败"),$(`#${id} progress`).val(0),$(`#${id} .uk-card-footer input`).val("图片上传失败"),$(`#${id} .uk-card-footer input`).attr("value","图片上传失败");let index=0,length=0;$("#dedecms-album-preview .uk-card-body div").each((function(){"图片上传中..."!==$(this).html()&&index++,length++})),albumPreviewProgress.removeClass("uk-hidden"),albumPreviewProgress.children("progress").attr("value",index),albumPreviewProgress.children("progress").attr("max",length),index===length&&(UIkit.notification({message:"图片上传完毕",status:"success",pos:"bottom-center",timeout:1e4}),$(".uk-card-header div").removeClass("uk-invisible"),$(".uk-card-body input").removeAttr("disabled"),$(".uk-card-body div").html("点击图片进行修改"),$(".uk-card-footer input").each((function(){"图片上传失败"!==$(this).val()&&$(this).removeAttr("disabled")})),dedecmsAlbumUploadDataUpdate())}))}}))),$(that).after($(that).clone().val("")),$(that).remove()}function dedecmsAlbumPreviewDelete(that){let div=$(that).parent().parent().parent().parent(),name=div.children(".dedecms-album-preview-name").val(),remark=div.children(".dedecms-album-preview-remark").val(),albumUploadFiles=$("#dedecms-album-upload-files");if(""===name||""===remark)div.remove();else{let formData=new FormData;formData.append("dopost","delete"),formData.append("delete",name),$.ajax({method:"POST",url:"upload.php",data:formData,processData:!1,contentType:!1}).always((function(res){"success"===res?(albumUploadData=objArrayRemove(albumUploadData,"name",name),albumUploadFiles.val(JSON.stringify(albumUploadData)),div.remove()):UIkit.notification({message:"图片删除失败",status:"danger",pos:"bottom-center",timeout:1e4})}))}}function dedecmsAlbumPreviewEdit(that){let files=$(that).prop("files");if(files){files=Array.from(files);let file=files[0];if(void 0===file)return;if(file.size>1024*fileSize*1024)return void UIkit.notification({message:`[${file.name}] 图片大小超过${fileSize}MB`,status:"danger",pos:"bottom-center",timeout:1e4});if(/(image\/)/i.test(file.type)){let div=$(that).parent().parent().parent(),name=div.children(".dedecms-album-preview-name").val(),id=div.attr("id");$(`#${id} .dedecms-album-preview-name`).val(""),$(`#${id} .dedecms-album-preview-remark`).val(""),$(`#${id} .uk-card-header div`).addClass("uk-invisible"),$(`#${id} .uk-card-body input`).attr("disabled","disabled"),$(`#${id} .uk-card-body div`).html("图片上传中..."),$(`#${id} progress`).val(0),$(`#${id} .uk-card-footer input`).val("图片上传中..."),$(`#${id} .uk-card-footer input`).attr("value","图片上传中..."),$(`#${id} .uk-card-footer input`).attr("disabled","disabled");let reader=new FileReader;reader.onload=function(){$(`#${id} img`).attr("src",this.result)},reader.readAsDataURL(file);let formData=new FormData;formData.append("file",file),formData.append("delete",name),$.ajax({method:"POST",url:"upload.php",data:formData,dataType:"json",processData:!1,contentType:!1}).always((function(res){if("success"===res.status){let name=res.name,remark=res.remark;$(`#${id} .dedecms-album-preview-name`).val(name),$(`#${id} .dedecms-album-preview-remark`).val(remark),$(`#${id} .uk-card-body div`).html("图片上传成功"),$(`#${id} progress`).val(100),$(`#${id} .uk-card-footer input`).val(remark),$(`#${id} .uk-card-footer input`).attr("value",remark)}else $(`#${id} .dedecms-album-preview-name`).val(""),$(`#${id} .dedecms-album-preview-remark`).val(""),$(`#${id} .uk-card-body div`).html("图片上传失败"),$(`#${id} progress`).val(0),$(`#${id} .uk-card-footer input`).val("图片上传失败"),$(`#${id} .uk-card-footer input`).attr("value","图片上传失败");$(`#${id} .uk-card-header div`).removeClass("uk-invisible"),$(`#${id} .uk-card-body input`).removeAttr("disabled"),$(`#${id} .uk-card-body div`).html("点击图片进行修改"),$(`#${id} .uk-card-footer input`).each((function(){"图片上传失败"!==$(this).val()&&$(this).removeAttr("disabled")})),dedecmsAlbumUploadDataUpdate(),$(that).after($(that).clone().val("")),$(that).remove()}))}}else{let div,id=$(that).parent().parent().parent().parent().attr("id"),remark=$(that).val();$(`#${id} .dedecms-album-preview-remark`).val(remark),$(`#${id} .uk-card-footer input`).val(remark),$(`#${id} .uk-card-footer input`).attr("value",remark),dedecmsAlbumUploadDataUpdate()}}function dedecmsAlbumUploadDataUpdate(){$(document).ready((function(){let name=[],remark=[],albumUploadFiles=$("#dedecms-album-upload-files");$(".dedecms-album-preview-name").each((function(){name.push($(this).val())})),$(".dedecms-album-preview-remark").each((function(){remark.push($(this).val())})),albumUploadData=[];for(let i=0;i<name.length;i++)""!==name[i]&&""!==remark[i]&&albumUploadData.push({name:name[i],remark:remark[i]});albumUploadFiles.val(JSON.stringify(albumUploadData))}))}$(document).ready((function(){dedecmsAlbumDataUpdate()})),UIkit.util.on(document,"moved","#dedecms-album",(function(item){dedecmsAlbumDataUpdate()})),UIkit.util.on(document,"moved","#dedecms-album-preview",(function(item){dedecmsAlbumUploadDataUpdate()}));